<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Weather Data Query</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="main-container">
        <header class="header-section">
            <div class="header-content">
                <div class="header-icon">
                    <img src="{{ url_for('static', filename='IMD Logo.png') }}" style="width: 80px; height: 80px;">
                </div>
                <div class="header-text">
                    <h1>Advanced Weather Data Query</h1>
                    <p>Powerful querying with column selection and outlier detection</p>
                </div>
            </div>
        </header>

        <div class="content-wrapper">
            <aside class="sidebar">
                <div class="sidebar-section">
                    <div class="section-header">
                        <i class="fas fa-filter"></i>
                        <h3>Query Filters</h3>
                    </div>

                    <!-- Date Range -->
                    <div class="filter-group">
                        <h4><i class="fas fa-calendar-alt"></i> Date Range</h4>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-input">
                            </div>
                            <div class="input-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- Location Filter -->
                    <div class="filter-group">
                        <h4><i class="fas fa-map-marker-alt"></i> Location</h4>
                        <div class="input-group">
                            <select id="location" class="form-select">
                                <option value="">All Locations</option>
                                {% for location in locations %}
                                <option value="{{ location }}">{{ location }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Column Selection -->
                    <div class="filter-group">
                        <h4><i class="fas fa-columns"></i> Select Columns</h4>
                        <div class="input-group">
                            <select id="columns" class="form-select" multiple size="10">
                                <!-- Will be populated by JavaScript -->
                            </select>
                            <small class="form-text">Hold Ctrl/Cmd to select multiple</small>
                        </div>
                    </div>

                    <!-- Outlier Detection -->
                    <div class="filter-group">
                        <h4><i class="fas fa-exclamation-triangle"></i> Outlier Detection</h4>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="outlierColumn">Column</label>
                                <select id="outlierColumn" class="form-select">
                                    <option value="">Select column</option>
                                    <!-- Will be populated by JavaScript -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="outlierThreshold">Threshold (σ)</label>
                                <input type="number" id="outlierThreshold" value="3" step="0.1" min="1" class="form-input">
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="executeQuery()">
                            <i class="fas fa-search"></i> Query Data
                        </button>
                        <button class="btn btn-success" onclick="downloadData()">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-info" onclick="detectOutliers()">
                            <i class="fas fa-chart-line"></i> Find Outliers
                        </button>
                        <button class="btn btn-warning" onclick="clearFilters()">
                            <i class="fas fa-refresh"></i> Clear
                        </button>
                    </div>
                </div>
            </aside>

            <main class="main-content">
                <div id="messageContainer"></div>

                <div id="loadingContainer" class="loading-container" style="display: none;">
                    <div class="loading-spinner"></div>
                    <p>Loading data...</p>
                </div>

                <!-- Results Section -->
                <div class="results-section">
                    <div class="section-header">
                        <i class="fas fa-table"></i>
                        <h3>Query Results</h3>
                    </div>

                    <div id="resultsContainer" class="table-section" style="display: none;">
                        <div class="table-wrapper">
                            <table class="data-table" id="resultsTable">
                                <thead>
                                    <tr id="tableHeaders"></tr>
                                </thead>
                                <tbody id="dataTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Outliers Section -->
                <div class="results-section" id="outliersSection" style="display: none;">
                    <div class="section-header">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Outlier Detection Results</h3>
                    </div>

                    <div id="outliersContainer" class="table-section">
                        <div class="table-wrapper">
                            <table class="data-table" id="outliersTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>Value</th>
                                        <th>Z-Score</th>
                                    </tr>
                                </thead>
                                <tbody id="outliersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Initialize column selectors
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/advanced-query/columns')
                .then(response => response.json())
                .then(data => {
                    const columnsSelect = document.getElementById('columns');
                    const outlierColumnSelect = document.getElementById('outlierColumn');

                    data.columns.forEach(column => {
                        const option1 = document.createElement('option');
                        option1.value = column;
                        option1.textContent = column;
                        columnsSelect.appendChild(option1);

                        const option2 = document.createElement('option');
                        option2.value = column;
                        option2.textContent = column;
                        outlierColumnSelect.appendChild(option2);
                    });
                });
        });

        function executeQuery() {
            const filters = collectFilters();
            showLoading();

            fetch('/advanced-query/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displayResults(data.data);
                    showMessage(`Found ${data.total} records`, 'success');
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('Error: ' + error.message, 'error');
            });
        }

        function detectOutliers() {
            const filters = collectFilters();
            const column = document.getElementById('outlierColumn').value;
            const threshold = document.getElementById('outlierThreshold').value;

            if (!column) {
                showMessage('Please select a column for outlier detection', 'error');
                return;
            }

            showLoading();

            fetch('/advanced-query/outliers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({...filters, column, threshold})
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                if (data.success) {
                    displayOutliers(data.outliers);
                    showMessage(`Found ${data.total_outliers} outliers in ${data.total_records} records (column: ${data.column})`, 'success');
                } else {
                    showMessage('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                hideLoading();
                showMessage('Error: ' + error.message, 'error');
            });
        }

        function downloadData() {
            const filters = collectFilters();
            showMessage('Preparing download...', 'info');

            fetch('/advanced-query/download', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Download failed');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `weather_data_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showMessage('Download completed!', 'success');
            })
            .catch(error => {
                showMessage('Download error: ' + error.message, 'error');
            });
        }

        function collectFilters() {
            const columnSelect = document.getElementById('columns');
            const selectedColumns = Array.from(columnSelect.selectedOptions).map(opt => opt.value);

            return {
                start_date: document.getElementById('startDate').value,
                end_date: document.getElementById('endDate').value,
                location: document.getElementById('location').value,
                columns: selectedColumns.length > 0 ? selectedColumns : null
            };
        }

        function displayResults(data) {
            const table = document.getElementById('resultsTable');
            const thead = document.getElementById('tableHeaders');
            const tbody = document.getElementById('dataTableBody');

            // Clear previous results
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="20" class="no-data">No data found</td></tr>';
                document.getElementById('resultsContainer').style.display = 'block';
                return;
            }

            // Create headers from first item's keys
            const headers = Object.keys(data[0]);
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                thead.appendChild(th);
            });

            // Add data rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    let value = row[header];

                    if (value === null || value === undefined) {
                        value = 'N/A';
                    } else if (typeof value === 'number') {
                        // Format numbers nicely
                        if (header.includes('temp') || header.includes('Temp')) {
                            value = value.toFixed(1) + '°C';
                        } else if (header.includes('pressure') || header.includes('Pressure')) {
                            value = value.toFixed(2) + ' hPa';
                        } else if (header.includes('humidity')) {
                            value = value.toFixed(1) + '%';
                        } else if (header.includes('rainfall')) {
                            value = value.toFixed(1) + ' mm';
                        } else {
                            value = value.toFixed(2);
                        }
                    } else if (header === 'date' && value) {
                        value = new Date(value).toLocaleDateString();
                    }

                    td.textContent = value;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('resultsContainer').style.display = 'block';
            document.getElementById('outliersSection').style.display = 'none';
        }

        function displayOutliers(outliers) {
            const tbody = document.getElementById('outliersTableBody');
            tbody.innerHTML = '';

            if (outliers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="no-data">No outliers found</td></tr>';
            } else {
                outliers.forEach(outlier => {
                    const tr = document.createElement('tr');

                    const dateTd = document.createElement('td');
                    dateTd.textContent = outlier.date || 'N/A';
                    tr.appendChild(dateTd);

                    const locTd = document.createElement('td');
                    locTd.textContent = outlier.location || 'N/A';
                    tr.appendChild(locTd);

                    const valueTd = document.createElement('td');
                    valueTd.textContent = typeof outlier.value === 'number' ? outlier.value.toFixed(2) : outlier.value;
                    tr.appendChild(valueTd);

                    const zTd = document.createElement('td');
                    zTd.textContent = outlier.z_score.toFixed(2);
                    tr.appendChild(zTd);

                    tbody.appendChild(tr);
                });
            }

            document.getElementById('outliersSection').style.display = 'block';
            document.getElementById('resultsContainer').style.display = 'none';
        }

        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('location').value = '';
            document.getElementById('columns').selectedIndex = -1;
            document.getElementById('outlierColumn').value = '';
            document.getElementById('outlierThreshold').value = '3';

            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('outliersSection').style.display = 'none';
            document.getElementById('messageContainer').innerHTML = '';

            showMessage('Filters cleared', 'info');
        }

        function showLoading() {
            document.getElementById('loadingContainer').style.display = 'flex';
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('outliersSection').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingContainer').style.display = 'none';
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
            container.innerHTML = '';
            container.appendChild(messageDiv);
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>